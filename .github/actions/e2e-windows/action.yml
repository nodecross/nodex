name: e2e test
description: "E2E test action"
inputs:
  binary-path:
    required: true
    description: "the path of the binary to be tested"
runs:
  using: composite
  steps:

    - name: Setup Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '18.20.1'

    - name: (setup) copy default config to home
      shell: powershell
      run: New-Item -ItemType Directory -Force -Path $env:USERPROFILE\.config\nodex; Copy-Item test_resource\config\* $env:USERPROFILE\.config\nodex\

    - name: Install Prism CLI
      shell: powershell
      run: npm install -g @stoplight/prism-cli

    - name: Get Prism Path
      id: get-prism-path
      shell: powershell
      run: |
        $prismPath = Get-Command prism | Select-Object -ExpandProperty Source
        echo "::set-output name=prismPath::$prismPath"

    - name: Setup and Run Tests
      shell: powershell
      run: |
        $prismPath = "${{ steps.get-prism-path.outputs.prismPath }}"
        $sidetreeResourcePath = Join-Path -Path $PWD -ChildPath "test_resource/did_sidetree.yaml"
        $studioResourcePath = Join-Path -Path $PWD -ChildPath "test_resource/studio.yaml"

        Start-Process -NoNewWindow -FilePath "powershell" -ArgumentList "-File $prismPath mock -h 127.0.0.1 -p 4010 $sidetreeResourcePath"
        Start-Process -NoNewWindow -FilePath "powershell" -ArgumentList "-File $prismPath mock -h 127.0.0.1 -p 8020 $studioResourcePath"
        Start-Sleep -Seconds 10

        $agentPath = Join-Path -Path $PWD -ChildPath ${{ inputs.binary-path }}
        $outputPath = Join-Path -Path $PWD -ChildPath "output.txt"
        $errorPath = Join-Path -Path $PWD -ChildPath "error.txt"
        Start-Process -FilePath "$agentPath" -NoNewWindow -RedirectStandardOutput "$outputPath" -RedirectStandardError "$errorPath"
        Start-Sleep -Seconds 10

        cd e2e
        cargo test

        Get-Process nodex-agent | Stop-Process -Force
        if (Select-String -Path "$outputPath" -Pattern "SIGINT") {
          echo "SIGINT Successfully"
        } else {
          echo "SIGINT Failed"
          exit 1
        }
      env:
        NODEX_DID_HTTP_ENDPOINT: http://127.0.0.1:4010
        NODEX_DID_ATTACHMENT_LINK: http://127.0.0.1:4010
        NODEX_STUDIO_HTTP_ENDPOINT: http://127.0.0.1:8020
        NODEX_SERVER_PORT: 3000
        RUST_BACKTRACE: 1

    - name: (run) show log of agent
      shell: powershell
      run: Get-Content "output.txt"
      if: ${{ always() }}
